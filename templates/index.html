
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ùù® CHESS - Python Chess Game</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <header>
        <h1>ùù® CHESS</h1>
    </header>
    
    <main>
        <div class="game-container">
            <div class="captured-pieces black-captured">
                <h3>Captured by White</h3>
                <div id="black-captured-pieces" class="pieces-container"></div>
            </div>
            
            <div class="chess-board" id="chess-board">
                <!-- Chess board will be dynamically generated -->
            </div>
            
            <div class="captured-pieces white-captured">
                <h3>Captured by Black</h3>
                <div id="white-captured-pieces" class="pieces-container"></div>
            </div>
        </div>
        
        <div class="controls">
            <button id="reset-game">New Game</button>
            <select id="game-mode">
                <option value="human_vs_human">Human vs Human</option>
                <option value="human_vs_ai">Human vs AI</option>
            </select>
            <select id="board-style">
                <option value="classic">Classic</option>
                <option value="blue">Blue</option>
                <option value="green">Green</option>
            </select>
        </div>
        
        <div class="piece-customization">
            <h3>Custom Pieces</h3>
            <div class="upload-container">
                <div class="piece-upload">
                    <label>White King:</label>
                    <input type="file" id="upload-wK" accept="image/png, image/jpeg" data-piece="wK" class="piece-uploader">
                </div>
                <div class="piece-upload">
                    <label>White Queen:</label>
                    <input type="file" id="upload-wQ" accept="image/png, image/jpeg" data-piece="wQ" class="piece-uploader">
                </div>
                <div class="piece-upload">
                    <label>White Rook:</label>
                    <input type="file" id="upload-wR" accept="image/png, image/jpeg" data-piece="wR" class="piece-uploader">
                </div>
                <div class="piece-upload">
                    <label>White Bishop:</label>
                    <input type="file" id="upload-wB" accept="image/png, image/jpeg" data-piece="wB" class="piece-uploader">
                </div>
                <div class="piece-upload">
                    <label>White Knight:</label>
                    <input type="file" id="upload-wN" accept="image/png, image/jpeg" data-piece="wN" class="piece-uploader">
                </div>
                <div class="piece-upload">
                    <label>White Pawn:</label>
                    <input type="file" id="upload-wP" accept="image/png, image/jpeg" data-piece="wP" class="piece-uploader">
                </div>
            </div>
            <div class="upload-container">
                <div class="piece-upload">
                    <label>Black King:</label>
                    <input type="file" id="upload-bK" accept="image/png, image/jpeg" data-piece="bK" class="piece-uploader">
                </div>
                <div class="piece-upload">
                    <label>Black Queen:</label>
                    <input type="file" id="upload-bQ" accept="image/png, image/jpeg" data-piece="bQ" class="piece-uploader">
                </div>
                <div class="piece-upload">
                    <label>Black Rook:</label>
                    <input type="file" id="upload-bR" accept="image/png, image/jpeg" data-piece="bR" class="piece-uploader">
                </div>
                <div class="piece-upload">
                    <label>Black Bishop:</label>
                    <input type="file" id="upload-bB" accept="image/png, image/jpeg" data-piece="bB" class="piece-uploader">
                </div>
                <div class="piece-upload">
                    <label>Black Knight:</label>
                    <input type="file" id="upload-bN" accept="image/png, image/jpeg" data-piece="bN" class="piece-uploader">
                </div>
                <div class="piece-upload">
                    <label>Black Pawn:</label>
                    <input type="file" id="upload-bP" accept="image/png, image/jpeg" data-piece="bP" class="piece-uploader">
                </div>
            </div>
            <button id="reset-pieces">Reset to Default Pieces</button>
        </div>
        
        <div class="overlay" id="overlay"></div>
        
        <div class="promotion-dialog" id="promotion-dialog">
            <h3>Choose Promotion</h3>
            <div class="promotion-options">
                <div class="promotion-piece" data-piece-type="queen">
                    <img src="" alt="Queen" id="promotion-queen">
                </div>
                <div class="promotion-piece" data-piece-type="rook">
                    <img src="" alt="Rook" id="promotion-rook">
                </div>
                <div class="promotion-piece" data-piece-type="bishop">
                    <img src="" alt="Bishop" id="promotion-bishop">
                </div>
                <div class="promotion-piece" data-piece-type="knight">
                    <img src="" alt="Knight" id="promotion-knight">
                </div>
            </div>
        </div>
    </main>
    
    <script>
        // Image paths for the chess pieces
        const DEFAULT_PIECE_IMAGES = {
            'white': {
                'pawn': '/lovable-uploads/68deda6e-0257-437e-8a96-ebf4be651592.png',
                'rook': '/lovable-uploads/c954dc96-c90f-4faf-a1ad-2d6c20b5bc1c.png',
                'knight': '/lovable-uploads/7dc10eb4-08f6-41a4-a4e8-293f333e92b2.png',
                'bishop': '/lovable-uploads/1fe7bb25-78b3-4e64-9524-3eb4dd0f66e3.png',
                'queen': '/lovable-uploads/bc8ca135-f693-4e57-bc85-cae391227a7a.png',
                'king': '/lovable-uploads/29bbe838-33f0-40c4-98b8-c95ef9aa1e66.png'
            },
            'black': {
                'pawn': '/lovable-uploads/42db49b6-4535-4db8-a445-c3f233f38136.png',
                'rook': '/lovable-uploads/a84e8f3a-313e-4cfd-b6da-541a3c84dd32.png',
                'knight': '/lovable-uploads/94bcdfe7-3b05-4721-b0ad-e748321de400.png',
                'bishop': '/lovable-uploads/c506906f-2e4f-43bf-85b9-e1485ce8088c.png',
                'queen': '/lovable-uploads/bede6588-797b-47e5-98bd-bba03accda0a.png',
                'king': '/lovable-uploads/2c29fb54-b770-4192-ad2e-f15afd2c7323.png'
            }
        };

        // Custom piece images (will be populated by uploaded images)
        let CUSTOM_PIECE_IMAGES = {};
        
        // Actual piece images to use (starts with defaults)
        let PIECE_IMAGES = JSON.parse(JSON.stringify(DEFAULT_PIECE_IMAGES));

        document.addEventListener('DOMContentLoaded', function() {
            let gameState = null;
            const chessBoard = document.getElementById('chess-board');
            const blackCapturedContainer = document.getElementById('black-captured-pieces');
            const whiteCapturedContainer = document.getElementById('white-captured-pieces');
            const resetButton = document.getElementById('reset-game');
            const gameModeSelect = document.getElementById('game-mode');
            const boardStyleSelect = document.getElementById('board-style');
            const overlay = document.getElementById('overlay');
            const promotionDialog = document.getElementById('promotion-dialog');
            const promotionPieces = document.querySelectorAll('.promotion-piece');
            const resetPiecesButton = document.getElementById('reset-pieces');
            const pieceUploaders = document.querySelectorAll('.piece-uploader');
            
            // Set promotion piece images
            document.getElementById('promotion-queen').src = PIECE_IMAGES.white.queen;
            document.getElementById('promotion-rook').src = PIECE_IMAGES.white.rook;
            document.getElementById('promotion-bishop').src = PIECE_IMAGES.white.bishop;
            document.getElementById('promotion-knight').src = PIECE_IMAGES.white.knight;
            
            // Load custom pieces from localStorage if available
            loadCustomPieces();
            
            // Initialize game
            fetchGameState();
            
            // Set up event listeners
            resetButton.addEventListener('click', resetGame);
            boardStyleSelect.addEventListener('change', updateBoardStyle);
            resetPiecesButton.addEventListener('click', resetToDefaultPieces);
            
            // Set up piece uploaders
            pieceUploaders.forEach(uploader => {
                uploader.addEventListener('change', handlePieceUpload);
            });
            
            // Handle promotion piece selection
            promotionPieces.forEach(piece => {
                piece.addEventListener('click', function() {
                    const pieceType = this.getAttribute('data-piece-type');
                    promotePawn(pieceType);
                });
            });
            
            function loadCustomPieces() {
                try {
                    const savedCustomPieces = localStorage.getItem('customPieceImages');
                    if (savedCustomPieces) {
                        CUSTOM_PIECE_IMAGES = JSON.parse(savedCustomPieces);
                        
                        // Apply custom pieces to the current set
                        for (const color in CUSTOM_PIECE_IMAGES) {
                            for (const pieceType in CUSTOM_PIECE_IMAGES[color]) {
                                PIECE_IMAGES[color][pieceType] = CUSTOM_PIECE_IMAGES[color][pieceType];
                            }
                        }
                    }
                } catch (e) {
                    console.error('Error loading custom pieces:', e);
                }
            }
            
            function handlePieceUpload(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const pieceCode = event.target.dataset.piece;
                const color = pieceCode[0] === 'w' ? 'white' : 'black';
                let pieceType;
                
                switch(pieceCode[1]) {
                    case 'P': pieceType = 'pawn'; break;
                    case 'R': pieceType = 'rook'; break;
                    case 'N': pieceType = 'knight'; break;
                    case 'B': pieceType = 'bishop'; break;
                    case 'Q': pieceType = 'queen'; break;
                    case 'K': pieceType = 'king'; break;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    // Store the image as base64
                    if (!CUSTOM_PIECE_IMAGES[color]) CUSTOM_PIECE_IMAGES[color] = {};
                    CUSTOM_PIECE_IMAGES[color][pieceType] = e.target.result;
                    PIECE_IMAGES[color][pieceType] = e.target.result;
                    
                    // Save to localStorage
                    localStorage.setItem('customPieceImages', JSON.stringify(CUSTOM_PIECE_IMAGES));
                    
                    // Update the display
                    createChessBoard();
                    updateCapturedPieces();
                    
                    // If promoting, update promotion dialog
                    if (gameState && gameState.promotionPending) {
                        showPromotionDialog();
                    }
                };
                reader.readAsDataURL(file);
            }
            
            function resetToDefaultPieces() {
                // Reset to default pieces
                CUSTOM_PIECE_IMAGES = {};
                PIECE_IMAGES = JSON.parse(JSON.stringify(DEFAULT_PIECE_IMAGES));
                
                // Clear from localStorage
                localStorage.removeItem('customPieceImages');
                
                // Reset file inputs
                pieceUploaders.forEach(uploader => {
                    uploader.value = '';
                });
                
                // Update the display
                createChessBoard();
                updateCapturedPieces();
                
                // If promoting, update promotion dialog
                if (gameState && gameState.promotionPending) {
                    showPromotionDialog();
                }
            }
            
            function createChessBoard() {
                chessBoard.innerHTML = '';
                
                for (let row = 0; row < 8; row++) {
                    for (let col = 0; col < 8; col++) {
                        const square = document.createElement('div');
                        square.classList.add('chess-square');
                        
                        // Add light or dark class based on position
                        if ((row + col) % 2 === 0) {
                            square.classList.add('square-light');
                        } else {
                            square.classList.add('square-dark');
                        }
                        
                        // Add data attributes for position
                        square.setAttribute('data-row', row);
                        square.setAttribute('data-col', col);
                        
                        // Add piece if there is one at this position
                        const piece = gameState.board[row][col];
                        if (piece) {
                            const pieceElement = document.createElement('div');
                            pieceElement.classList.add('chess-piece');
                            
                            const img = document.createElement('img');
                            
                            // Map piece to the correct image
                            const color = piece.color === 'white' ? 'white' : 'black';
                            let pieceType;
                            switch(piece.type) {
                                case 'pawn': pieceType = 'pawn'; break;
                                case 'rook': pieceType = 'rook'; break;
                                case 'knight': pieceType = 'knight'; break;
                                case 'bishop': pieceType = 'bishop'; break;
                                case 'queen': pieceType = 'queen'; break;
                                case 'king': pieceType = 'king'; break;
                            }
                            
                            img.src = PIECE_IMAGES[color][pieceType];
                            img.alt = `${piece.color} ${piece.type}`;
                            
                            pieceElement.appendChild(img);
                            square.appendChild(pieceElement);
                        }
                        
                        // Highlight selected piece
                        if (gameState.selectedPiece && 
                            gameState.selectedPiece.row === row && 
                            gameState.selectedPiece.col === col) {
                            square.classList.add('square-selected');
                        }
                        
                        // Highlight possible moves
                        if (gameState.possibleMoves && gameState.possibleMoves.some(move => move.row === row && move.col === col)) {
                            square.classList.add('square-movable');
                        }
                        
                        // Add click event listener
                        square.addEventListener('click', () => handleSquareClick(row, col));
                        
                        chessBoard.appendChild(square);
                    }
                }
                
                updateBoardStyle();
            }
            
            function updateBoardStyle() {
                const style = boardStyleSelect.value;
                const squares = document.querySelectorAll('.chess-square');
                
                // Remove all style classes
                squares.forEach(square => {
                    square.classList.remove('square-light-blue', 'square-dark-blue', 
                                          'square-light-green', 'square-dark-green');
                });
                
                // Apply selected style
                if (style === 'blue') {
                    squares.forEach(square => {
                        if (square.classList.contains('square-light')) {
                            square.classList.add('square-light-blue');
                        } else {
                            square.classList.add('square-dark-blue');
                        }
                    });
                } else if (style === 'green') {
                    squares.forEach(square => {
                        if (square.classList.contains('square-light')) {
                            square.classList.add('square-light-green');
                        } else {
                            square.classList.add('square-dark-green');
                        }
                    });
                }
            }
            
            function updateCapturedPieces() {
                blackCapturedContainer.innerHTML = '';
                whiteCapturedContainer.innerHTML = '';
                
                if (gameState.capturedPieces) {
                    // Add black pieces captured by white
                    if (gameState.capturedPieces.black) {
                        gameState.capturedPieces.black.forEach(piece => {
                            const capturedPiece = document.createElement('div');
                            capturedPiece.classList.add('captured-piece');
                            
                            const img = document.createElement('img');
                            img.src = PIECE_IMAGES[piece.color][piece.type];
                            img.alt = `${piece.color} ${piece.type}`;
                            
                            capturedPiece.appendChild(img);
                            blackCapturedContainer.appendChild(capturedPiece);
                        });
                    }
                    
                    // Add white pieces captured by black
                    if (gameState.capturedPieces.white) {
                        gameState.capturedPieces.white.forEach(piece => {
                            const capturedPiece = document.createElement('div');
                            capturedPiece.classList.add('captured-piece');
                            
                            const img = document.createElement('img');
                            img.src = PIECE_IMAGES[piece.color][piece.type];
                            img.alt = `${piece.color} ${piece.type}`;
                            
                            capturedPiece.appendChild(img);
                            whiteCapturedContainer.appendChild(capturedPiece);
                        });
                    }
                }
            }
            
            function handleSquareClick(row, col) {
                // Don't allow clicks during promotion
                if (gameState.promotionPending) return;
                
                const selectedPiece = gameState.selectedPiece;
                
                // If no piece is selected, try to select one
                if (!selectedPiece) {
                    selectPiece(row, col);
                } else {
                    // If a piece is already selected, try to move it
                    const fromRow = selectedPiece.row;
                    const fromCol = selectedPiece.col;
                    
                    const isPossibleMove = gameState.possibleMoves.some(
                        move => move.row === row && move.col === col
                    );
                    
                    if (isPossibleMove) {
                        movePiece(fromRow, fromCol, row, col);
                    } else {
                        // If clicking on a different piece of the same color, select it
                        selectPiece(row, col);
                    }
                }
            }
            
            function selectPiece(row, col) {
                fetch('/api/select-piece', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ row, col }),
                })
                .then(response => response.json())
                .then(data => {
                    gameState = data;
                    createChessBoard();
                })
                .catch(error => console.error('Error selecting piece:', error));
            }
            
            function movePiece(fromRow, fromCol, toRow, toCol) {
                fetch('/api/move-piece', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ fromRow, fromCol, toRow, toCol }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        gameState = data.gameState;
                        createChessBoard();
                        updateCapturedPieces();
                        
                        // Check if pawn promotion is pending
                        if (gameState.promotionPending) {
                            showPromotionDialog();
                        }
                    }
                })
                .catch(error => console.error('Error moving piece:', error));
            }
            
            function promotePawn(pieceType) {
                fetch('/api/promote-pawn', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ pieceType }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        gameState = data.gameState;
                        createChessBoard();
                        updateCapturedPieces();
                        hidePromotionDialog();
                    }
                })
                .catch(error => console.error('Error promoting pawn:', error));
            }
            
            function resetGame() {
                fetch('/api/reset-game', {
                    method: 'POST',
                })
                .then(response => response.json())
                .then(data => {
                    gameState = data;
                    createChessBoard();
                    updateCapturedPieces();
                })
                .catch(error => console.error('Error resetting game:', error));
            }
            
            function fetchGameState() {
                fetch('/api/game-state')
                .then(response => response.json())
                .then(data => {
                    gameState = data;
                    createChessBoard();
                    updateCapturedPieces();
                })
                .catch(error => console.error('Error fetching game state:', error));
            }
            
            function showPromotionDialog() {
                // Update promotion images to match the current turn color and custom pieces
                const color = gameState.currentTurn;
                const colorKey = color === 'white' ? 'white' : 'black';
                
                document.getElementById('promotion-queen').src = PIECE_IMAGES[colorKey].queen;
                document.getElementById('promotion-rook').src = PIECE_IMAGES[colorKey].rook;
                document.getElementById('promotion-bishop').src = PIECE_IMAGES[colorKey].bishop;
                document.getElementById('promotion-knight').src = PIECE_IMAGES[colorKey].knight;
                
                overlay.classList.add('active');
                promotionDialog.classList.add('active');
            }
            
            function hidePromotionDialog() {
                overlay.classList.remove('active');
                promotionDialog.classList.remove('active');
            }
        });
    </script>
</body>
</html>
